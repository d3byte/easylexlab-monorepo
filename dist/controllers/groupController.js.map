{"version":3,"sources":["../../server/controllers/groupController.js"],"names":["locale","groupController","post","req","res","body","name","grade","user","permissions","code","Group","findOne","err","group","index","randomInteger","newCode","i","length","_teacher","id","save","then","newGroup","status","json","success","data","catch","message","delete","groupId","findByIdAndRemove","addStudent","groupCode","studentId","findOneAndUpdate","$push","existingGroup","getGroups","userId","find","populate","path","select","match","groups","getGroup","findById","addTest","stackId","Stack","_tests","push","stack","_id","error","regCode","newMsg","msgText","User","authorId","userAccount","author","firstName","lastName","pic","picUrl","text","date","format","notification","type","seen","findByIdAndUpdate","messages","update","_groups","$in","notifications","multi","changeName","$set","deleteMsg","msgId","filter","item","deleteGroup","removeStudent","$pull"],"mappings":";;;;;;AAAA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;;;AACA,iBAAOA,MAAP,CAAc,IAAd;;AAEA,IAAMC,kBAAkB,EAAxB;;AAEA;AACAA,gBAAgBC,IAAhB,GAAuB,UAACC,GAAD,EAAMC,GAAN,EAAc;AAAA,oBAI7BD,IAAIE,IAJyB;AAAA,QAE7BC,IAF6B,aAE7BA,IAF6B;AAAA,QAG7BC,KAH6B,aAG7BA,KAH6B;;;AAMjC,QAAMC,OAAOL,IAAIK,IAAjB;;AAEA,QAAIA,KAAKC,WAAL,IAAoB,OAApB,IAA+BD,KAAKC,WAAL,IAAoB,SAAvD,EAAkE;AAC9D,YAAMC,OAAO,0BAAU,IAAV,EAAgB,CAAhB,CAAb;AACA,yBAAGC,KAAH,CAASC,OAAT,CAAiB,EAACF,UAAD,EAAjB,EAAyB,UAACG,GAAD,EAAMC,KAAN,EAAgB;AACrC,gBAAID,GAAJ,EACI,MAAMA,GAAN;AACJ,gBAAIC,KAAJ,EAAW;AACP,oBAAIC,QAAQ,0BAAOC,aAAP,CAAqB,CAArB,EAAwB,CAAxB,CAAZ;AACA,oBAAIC,UAAU,EAAd;AACA,qBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIR,KAAKS,MAAzB,EAAiCD,GAAjC,EAAsC;AAClC,wBAAIA,KAAKH,KAAT,EAAgB;AACZE,mCAAWP,KAAKQ,CAAL,CAAX;AACH,qBAFD,MAEO;AACHD,mCAAW,0BAAU,IAAV,EAAgB,CAAhB,CAAX;AACH;AACJ;AACD,oBAAMH,SAAQ,IAAI,iBAAGH,KAAP,CAAa;AACvBL,8BADuB;AAEvBI,0BAAMO,OAFiB;AAGvBV,gCAHuB;AAIvBa,8BAAUZ,KAAKa;AAJQ,iBAAb,CAAd;AAMAP,uBAAMQ,IAAN,GAAaC,IAAb,CAAkB,UAACC,QAAD,EAAc;AAC5B,2BAAOpB,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBC,iCAAS,IADe;AAExBC,8BAAMJ;AAFkB,qBAArB,CAAP;AAIH,iBALD,EAKGK,KALH,CAKS,UAAChB,GAAD,EAAS;AACd,2BAAOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBI,iCAASjB;AADe,qBAArB,CAAP;AAGH,iBATD;AAUH,aA1BD,MA0BO;AACH,oBAAMC,UAAQ,IAAI,iBAAGH,KAAP,CAAa;AACvBL,8BADuB;AAEvBI,8BAFuB;AAGvBH,gCAHuB;AAIvBa,8BAAUZ,KAAKa;AAJQ,iBAAb,CAAd;;AAOAP,wBAAMQ,IAAN,GAAaC,IAAb,CAAkB,UAACC,QAAD,EAAc;AAC5B,2BAAOpB,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBC,iCAAS,IADe;AAExBC,8BAAMJ;AAFkB,qBAArB,CAAP;AAIH,iBALD,EAKGK,KALH,CAKS,UAAChB,GAAD,EAAS;AACd,2BAAOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBI,iCAASjB;AADe,qBAArB,CAAP;AAGH,iBATD;AAUH;AACJ,SAhDD;AAiDH,KAnDD,MAmDO;AACH,eAAOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBI,qBAAS;AADe,SAArB,CAAP;AAGH;AAEJ,CAjED;;AAmEA;AACA7B,gBAAgB8B,MAAhB,GAAyB,UAAC5B,GAAD,EAAMC,GAAN,EAAc;AACnC,QAAM4B,UAAU7B,IAAIE,IAAJ,CAAS2B,OAAzB;AACA,QAAMxB,OAAOL,IAAIK,IAAjB;;AAEA,QAAIA,KAAKC,WAAL,IAAoB,OAApB,IAA+BD,KAAKC,WAAL,IAAoB,SAAvD,EAAkE;AAC9D,yBAAGE,KAAH,CAASsB,iBAAT,CAA2BD,OAA3B,EAAoCT,IAApC,CAAyC,YAAM;AAC3C,mBAAOnB,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBC,yBAAS;AADe,aAArB,CAAP;AAGH,SAJD,EAIGE,KAJH,CAIS,UAAChB,GAAD,EAAS;AACd,mBAAOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBI,yBAASjB;AADe,aAArB,CAAP;AAGH,SARD;AASH,KAVD,MAUO;AACH,eAAOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBI,qBAAS;AADe,SAArB,CAAP;AAGH;AAEJ,CApBD;;AAsBA;AACA7B,gBAAgBiC,UAAhB,GAA6B,UAAC/B,GAAD,EAAMC,GAAN,EAAc;AAAA,qBAInCD,IAAIE,IAJ+B;AAAA,QAEnC8B,SAFmC,cAEnCA,SAFmC;AAAA,QAGnCC,SAHmC,cAGnCA,SAHmC;;;AAMvC,qBAAGzB,KAAH,CAAS0B,gBAAT,CACI,EAAC3B,MAAMyB,SAAP,EADJ,EAEI,EAACG,OAAO,EAAC,aAAaF,SAAd,EAAR,EAFJ,EAGEb,IAHF,CAGO,UAACgB,aAAD,EAAmB;AACtB,eAAOnC,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBC,qBAAS;AADe,SAArB,CAAP;AAGH,KAPD,EAOGE,KAPH,CAOS,UAAChB,GAAD,EAAS;AACd,eAAOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBI,qBAASjB;AADe,SAArB,CAAP;AAGH,KAXD;AAaH,CAnBD;;AAqBA;AACAZ,gBAAgBuC,SAAhB,GAA4B,UAACrC,GAAD,EAAMC,GAAN,EAAc;AACtC,QAAMqC,SAAStC,IAAIK,IAAJ,CAASa,EAAxB;;AAEA,qBAAGV,KAAH,CAAS+B,IAAT,CAAc,EAACtB,UAAUqB,MAAX,EAAd,EAAkCE,QAAlC,CAA2C;AACvCC,cAAM,UADiC;AAEvCC,gBAAQ,6BAF+B;AAGvCC,eAAO,EAAC,aAAa,KAAd;AAHgC,KAA3C,EAIGH,QAJH,CAIY;AACRC,cAAM,QADE;AAERC,gBAAQ;AAFA,KAJZ,EAOGF,QAPH,CAOY;AACRC,cAAM,WADE;AAERC,gBAAQ,eAFA;AAGRC,eAAO,EAAC,aAAa,KAAd;AAHC,KAPZ,EAWGvB,IAXH,CAWQ,UAACwB,MAAD,EAAY;AAChB,eAAO3C,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBC,qBAAS,IADe;AAExBC,kBAAMmB;AAFkB,SAArB,CAAP;AAIH,KAhBD,EAgBGlB,KAhBH,CAgBS,UAAChB,GAAD,EAAS;AACdT,YAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACjBI,qBAASjB;AADQ,SAArB;AAGH,KApBD;AAsBH,CAzBD;;AA2BA;AACAZ,gBAAgB+C,QAAhB,GAA2B,UAAC7C,GAAD,EAAMC,GAAN,EAAc;AACrC,QAAM4B,UAAU7B,IAAIE,IAAJ,CAAS2B,OAAzB;AACA,qBAAGrB,KAAH,CAASsC,QAAT,CAAkBjB,OAAlB,EAA2BW,QAA3B,CAAoC;AAChCC,cAAM,WAD0B;AAEhCC,gBAAQ,EAFwB;AAGhCC,eAAO,EAAC,aAAa,KAAd;AAHyB,KAApC,EAIGH,QAJH,CAIY;AACRC,cAAM,QADE;AAERC,gBAAQ;AAFA,KAJZ,EAOGtB,IAPH,CAOQ,iBAAS;AACb,eAAOnB,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACxBC,qBAAS,IADe;AAExBb;AAFwB,SAArB,CAAP;AAIH,KAZD,EAYGe,KAZH,CAYS,UAAChB,GAAD,EAAS;AACdT,YAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACjBI,qBAASjB;AADQ,SAArB;AAGH,KAhBD;AAkBH,CApBD;;AAsBA;AACAZ,gBAAgBiD,OAAhB,GAA0B,UAAC/C,GAAD,EAAMC,GAAN,EAAc;AAAA,qBAIhCD,IAAIE,IAJ4B;AAAA,QAEhC2B,OAFgC,cAEhCA,OAFgC;AAAA,QAGhCmB,OAHgC,cAGhCA,OAHgC;;;AAMpC,QAAM3C,OAAOL,IAAIK,IAAjB;;AAEA,QAAIA,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAzD,EAAkE;AAC9D,yBAAG2C,KAAH,CAASH,QAAT,CAAkBE,OAAlB,EAA2B5B,IAA3B,CAAgC,iBAAS;AACrC,6BAAGZ,KAAH,CAASsC,QAAT,CAAkBjB,OAAlB,EAA2BT,IAA3B,CAAgC,iBAAS;AACrCT,sBAAMuC,MAAN,CAAaC,IAAb,CAAkBC,MAAMC,GAAxB;AACA1C,sBAAMQ,IAAN,GAAaC,IAAb,CAAkB,eAAO;AACrBnB,wBAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACC,SAAS,IAAV,EAArB;AACH,iBAFD,EAEGE,KAFH,CAES,iBAAS;AACd,0BAAM4B,KAAN;AACH,iBAJD;AAKH,aAPD,EAOG5B,KAPH,CAOS,eAAO;AACZ,sBAAMhB,GAAN;AACH,aATD;AAUH,SAXD,EAWGgB,KAXH,CAWS,eAAO;AACZ,kBAAMhB,GAAN;AACH,SAbD;AAcH,KAfD,MAeOT,IAAIqB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAC,SAAS,gCAAV,EAArB;AAEV,CAzBD;;AA2BA;AACAzB,gBAAgByD,OAAhB,GAA0B,UAACvD,GAAD,EAAMC,GAAN,EAAc;AACpC,QAAM4B,UAAU7B,IAAIE,IAAJ,CAAS2B,OAAzB;AACA,QAAMxB,OAAOL,IAAIK,IAAjB;;AAEA,QAAIA,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAzD,EAAkE;AAC9D,yBAAGE,KAAH,CAASsC,QAAT,CAAkBjB,OAAlB,EAA2BT,IAA3B,CAAgC,iBAAS;AACrC,mBAAOnB,IAAIsB,IAAJ,CAAS;AACZC,yBAAS,IADG;AAEZQ,2BAAWrB,MAAMJ;AAFL,aAAT,CAAP;AAIH,SALD;AAMH;AACJ,CAZD;;AAcAT,gBAAgB0D,MAAhB,GAAyB,UAACxD,GAAD,EAAMC,GAAN,EAAc;AACnC,QAAMI,OAAOL,IAAIK,IAAjB;AADmC,qBAK/BL,IAAIE,IAL2B;AAAA,QAG/B2B,OAH+B,cAG/BA,OAH+B;AAAA,QAI/B4B,OAJ+B,cAI/BA,OAJ+B;;;AAQnC,QAAIpD,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAzD,EAAkE;AAC9D,yBAAGoD,IAAH,CAAQZ,QAAR,CAAiBzC,KAAKa,EAAtB,EAA0BE,IAA1B,CAA+B,uBAAe;AAC1C,gBAAMO,UAAU;AACZgC,0BAAUC,YAAYP,GADV;AAEZnC,oBAAI,0BAAU,GAAV,EAAe,EAAf,CAFQ;AAGZ2C,wBAAQD,YAAYE,SAAZ,GAAwB,GAAxB,GAA8BF,YAAYG,QAHtC;AAIZC,qBAAKJ,YAAYK,MAJL;AAKZC,sBAAMT,OALM;AAMZU,sBAAM,wBAASC,MAAT,CAAgB,IAAhB;AANM,aAAhB;;AASA,gBAAMC,eAAe;AACjBC,sBAAM,QADW;AAEjBX,0BAAUC,YAAYP,GAFL;AAGjBQ,wBAAQD,YAAYE,SAAZ,GAAwB,GAAxB,GAA8BF,YAAYG,QAHjC;AAIjBC,qBAAKJ,YAAYK,MAJA;AAKjBC,sBAASN,YAAYE,SAAZ,GAAwB,GAAxB,GAA8BF,YAAYG,QAAnD,8GALiB;AAMjBQ,sBAAM,KANW;AAOjBJ,sBAAM,wBAASC,MAAT,CAAgB,IAAhB,CAPW;AAQjBlD,oBAAI,0BAAU,IAAV,EAAgB,EAAhB;AARa,aAArB;;AAYA,6BAAGV,KAAH,CAASgE,iBAAT,CAA2B3C,OAA3B,EAAoC;AAChCM,uBAAO,EAAEsC,UAAU9C,OAAZ;AADyB,aAApC,EAEGP,IAFH,CAEQ,iBAAS;AACb,iCAAGsC,IAAH,CAAQgB,MAAR,CAAe,EAAEC,SAAS,EAAEC,KAAK,CAAC/C,OAAD,CAAP,EAAX,EAAf,EACI,EAAEM,OAAO,EAAE0C,eAAeR,YAAjB,EAAT,EADJ,EAC+C;AACzCS,2BAAO;AADkC,iBAD/C,EAGO1D,IAHP,CAGY,mBAAW;AACnBnB,wBAAIsB,IAAJ,CAAS,EAAEC,SAAS,IAAX,EAAiBG,gBAAjB,EAAT;AACH,iBALD,EAKGD,KALH,CAKS,iBAAS;AACd,0BAAM4B,KAAN;AACH,iBAPD;AAQH,aAXD,EAWG5B,KAXH,CAWS,eAAO;AACZ,sBAAMhB,GAAN;AACH,aAbD;AAcH,SApCD,EAoCGgB,KApCH,CAoCS,eAAO;AACZ,kBAAMhB,GAAN;AACH,SAtCD;AAuCH;AACJ,CAjDD;;AAmDAZ,gBAAgBiF,UAAhB,GAA6B,UAAC/E,GAAD,EAAMC,GAAN,EAAc;AAAA,qBAIrCD,IAAIE,IAJiC;AAAA,QAEvC2B,OAFuC,cAEvCA,OAFuC;AAAA,QAGvC1B,IAHuC,cAGvCA,IAHuC;;AAKzC,QAAME,OAAOL,IAAIK,IAAjB;;AAEA,QAAGA,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAxD,EAAiE;AAC/D,yBAAGE,KAAH,CAASgE,iBAAT,CAA2B3C,OAA3B,EAAoC,EAAEmD,MAAM,EAAE7E,UAAF,EAAR,EAApC,EAAwDiB,IAAxD,CAA6D,mBAAW;AACtE,mBAAOnB,IAAIsB,IAAJ,CAAS,EAAEC,SAAS,IAAX,EAAT,CAAP;AACD,SAFD;AAGD;AACF,CAZD;;AAcA1B,gBAAgBmF,SAAhB,GAA4B,UAACjF,GAAD,EAAMC,GAAN,EAAc;AAAA,qBAIpCD,IAAIE,IAJgC;AAAA,QAEtC2B,OAFsC,cAEtCA,OAFsC;AAAA,QAGtCqD,KAHsC,cAGtCA,KAHsC;;AAKxC,QAAM7E,OAAOL,IAAIK,IAAjB;;AAEA,QAAGA,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAxD,EAAiE;AAC/D,yBAAGE,KAAH,CAASsC,QAAT,CAAkBjB,OAAlB,EAA2BT,IAA3B,CAAgC,iBAAS;AACvCT,kBAAM8D,QAAN,GAAiB9D,MAAM8D,QAAN,CAAeU,MAAf,CAAsB;AAAA,uBAAQC,KAAKlE,EAAL,IAAWgE,KAAnB;AAAA,aAAtB,CAAjB;AACAvE,kBAAMQ,IAAN,GAAaC,IAAb,CAAkB;AAAA,uBAAKnB,IAAIsB,IAAJ,CAAS,EAAEC,SAAS,IAAX,EAAT,CAAL;AAAA,aAAlB;AACD,SAHD;AAID;AACF,CAbD;;AAeA1B,gBAAgBuF,WAAhB,GAA8B,UAACrF,GAAD,EAAMC,GAAN,EAAc;AAC1C,QAAM4B,UAAU7B,IAAIE,IAAJ,CAAS2B,OAAzB;AACA,QAAMxB,OAAOL,IAAIK,IAAjB;;AAEA,QAAGA,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAxD,EAAiE;AAC/D,yBAAGE,KAAH,CAASsB,iBAAT,CAA2BD,OAA3B,EAAoCT,IAApC,CAAyC;AAAA,mBAAWnB,IAAIsB,IAAJ,CAAS,EAAEC,gBAAF,EAAT,CAAX;AAAA,SAAzC;AACD;AACF,CAPD;;AASA1B,gBAAgBwF,aAAhB,GAAgC,UAACtF,GAAD,EAAMC,GAAN,EAAc;AAAA,qBAIxCD,IAAIE,IAJoC;AAAA,QAE1C2B,OAF0C,cAE1CA,OAF0C;AAAA,QAG1CS,MAH0C,cAG1CA,MAH0C;;AAK5C,QAAMjC,OAAOL,IAAIK,IAAjB;;AAEA,QAAGA,KAAKC,WAAL,IAAoB,SAApB,IAAiCD,KAAKC,WAAL,IAAoB,OAAxD,EAAiE;AAC/D,yBAAGE,KAAH,CAASgE,iBAAT,CAA2B3C,OAA3B,EAAoC;AAClC0D,mBAAO,EAAE,aAAajD,MAAf;AAD2B,SAApC,EAEGlB,IAFH,CAEQ,mBAAW;AAAEnB,gBAAIsB,IAAJ,CAAS,EAAEC,SAAS,IAAX,EAAT;AAA6B,SAFlD;AAGD;AACF,CAZD;;kBAce1B,e","file":"groupController.js","sourcesContent":["import randomize from 'randomatic';\r\nimport moment from 'moment';\r\n\r\nimport db from './../models';\r\nimport secret from './../secret';\r\nimport helper from './helperFunctions';\r\nmoment.locale('ru');\r\n\r\nconst groupController = {};\r\n\r\n// New group\r\ngroupController.post = (req, res) => {\r\n    const {\r\n        name,\r\n        grade\r\n    } = req.body;\r\n\r\n    const user = req.user;\r\n\r\n    if (user.permissions == \"admin\" || user.permissions == \"teacher\") {\r\n        const code = randomize('A0', 5);\r\n        db.Group.findOne({code}, (err, group) => {\r\n            if (err)\r\n                throw err;\r\n            if (group) {\r\n                let index = helper.randomInteger(1, 5);\r\n                var newCode = '';\r\n                for (let i = 0; i < code.length; i++) {\r\n                    if (i != index) {\r\n                        newCode += code[i];\r\n                    } else {\r\n                        newCode += randomize('A0', 1);\r\n                    }\r\n                }\r\n                const group = new db.Group({\r\n                    name,\r\n                    code: newCode,\r\n                    grade,\r\n                    _teacher: user.id\r\n                });\r\n                group.save().then((newGroup) => {\r\n                    return res.status(200).json({\r\n                        success: true,\r\n                        data: newGroup\r\n                    });\r\n                }).catch((err) => {\r\n                    return res.status(500).json({\r\n                        message: err\r\n                    });\r\n                });\r\n            } else {\r\n                const group = new db.Group({\r\n                    name,\r\n                    code,\r\n                    grade,\r\n                    _teacher: user.id\r\n                });\r\n\r\n                group.save().then((newGroup) => {\r\n                    return res.status(200).json({\r\n                        success: true,\r\n                        data: newGroup\r\n                    });\r\n                }).catch((err) => {\r\n                    return res.status(500).json({\r\n                        message: err\r\n                    });\r\n                });\r\n            }\r\n        });\r\n    } else {\r\n        return res.status(501).json({\r\n            message: 'Access denied'\r\n        });\r\n    }\r\n\r\n};\r\n\r\n// Remove group\r\ngroupController.delete = (req, res) => {\r\n    const groupId = req.body.groupId;\r\n    const user = req.user;\r\n\r\n    if (user.permissions == \"admin\" || user.permissions == \"teacher\") {\r\n        db.Group.findByIdAndRemove(groupId).then(() => {\r\n            return res.status(200).json({\r\n                success: true\r\n            });\r\n        }).catch((err) => {\r\n            return res.status(500).json({\r\n                message: err\r\n            });\r\n        });\r\n    } else {\r\n        return res.status(501).json({\r\n            message: 'Access denied'\r\n        });\r\n    }\r\n\r\n};\r\n\r\n// Add student\r\ngroupController.addStudent = (req, res) => {\r\n    const {\r\n        groupCode,\r\n        studentId\r\n    } = req.body;\r\n\r\n    db.Group.findOneAndUpdate(\r\n        {code: groupCode},\r\n        {$push: {'_students': studentId}},\r\n    ).then((existingGroup) => {\r\n        return res.status(200).json({\r\n            success: true\r\n        });\r\n    }).catch((err) => {\r\n        return res.status(500).json({\r\n            message: err\r\n        });\r\n    });\r\n\r\n};\r\n\r\n// Get groups of teacher\r\ngroupController.getGroups = (req, res) => {\r\n    const userId = req.user.id;\r\n\r\n    db.Group.find({_teacher: userId}).populate({\r\n        path: '_teacher',\r\n        select: 'name username createdAt _id',\r\n        match: {'isDeleted': false}\r\n    }).populate({\r\n        path: '_tests',\r\n        select: 'name tasks timeToDo _group attempts results'\r\n    }).populate({\r\n        path: '_students',\r\n        select: 'name username',\r\n        match: {'isDeleted': false}\r\n    }).then((groups) => {\r\n        return res.status(200).json({\r\n            success: true,\r\n            data: groups\r\n        });\r\n    }).catch((err) => {\r\n        res.status(500).json({\r\n            message: err\r\n        })\r\n    });\r\n\r\n};\r\n\r\n// Watch one exact group\r\ngroupController.getGroup = (req, res) => {\r\n    const groupId = req.body.groupId;\r\n    db.Group.findById(groupId).populate({\r\n        path: '_students',\r\n        select: '',\r\n        match: {'isDeleted': false}\r\n    }).populate({\r\n        path: '_tests',\r\n        select: 'name tasks timeToDo _group attempts results'\r\n    }).then(group => {\r\n        return res.status(200).json({\r\n            success: true,\r\n            group\r\n        });\r\n    }).catch((err) => {\r\n        res.status(500).json({\r\n            message: err\r\n        });\r\n    });\r\n\r\n};\r\n\r\n// Stick test to group\r\ngroupController.addTest = (req, res) => {\r\n    const {\r\n        groupId,\r\n        stackId\r\n    } = req.body;\r\n\r\n    const user = req.user;\r\n\r\n    if (user.permissions == 'teacher' || user.permissions == 'admin') {\r\n        db.Stack.findById(stackId).then(stack => {\r\n            db.Group.findById(groupId).then(group => {\r\n                group._tests.push(stack._id);\r\n                group.save().then(suc => {\r\n                    res.status(200).json({success: true});\r\n                }).catch(error => {\r\n                    throw error;\r\n                });\r\n            }).catch(err => {\r\n                throw err;\r\n            });\r\n        }).catch(err => {\r\n            throw err;\r\n        });\r\n    } else res.status(501).json({'error': 'No permissions for this action'});\r\n\r\n};\r\n\r\n// Registration link\r\ngroupController.regCode = (req, res) => {\r\n    const groupId = req.body.groupId;\r\n    const user = req.user;\r\n\r\n    if (user.permissions == 'teacher' || user.permissions == 'admin') {\r\n        db.Group.findById(groupId).then(group => {\r\n            return res.json({\r\n                success: true,\r\n                groupCode: group.code\r\n            });\r\n        });\r\n    }\r\n};\r\n\r\ngroupController.newMsg = (req, res) => {\r\n    const user = req.user;\r\n    const {\r\n        groupId,\r\n        msgText\r\n    } = req.body;\r\n\r\n\r\n    if (user.permissions == 'teacher' || user.permissions == 'admin') {\r\n        db.User.findById(user.id).then(userAccount => {\r\n            const message = {\r\n                authorId: userAccount._id,\r\n                id: randomize('*', 15),\r\n                author: userAccount.firstName + \" \" + userAccount.lastName,\r\n                pic: userAccount.picUrl,\r\n                text: msgText,\r\n                date: moment().format('LL')\r\n            };\r\n\r\n            const notification = {\r\n                type: 'newMsg',\r\n                authorId: userAccount._id,\r\n                author: userAccount.firstName + \" \" + userAccount.lastName,\r\n                pic: userAccount.picUrl,\r\n                text: `${userAccount.firstName + \" \" + userAccount.lastName} отправил сообщение.`,\r\n                seen: false,\r\n                date: moment().format('LL'),\r\n                id: randomize('0A', 10)\r\n            };\r\n\r\n\r\n            db.Group.findByIdAndUpdate(groupId, {\r\n                $push: { messages: message }\r\n            }).then(group => {\r\n                db.User.update({ _groups: { $in: [groupId] }},\r\n                    { $push: { notifications: notification }}, {\r\n                      multi: true\r\n                    }).then(success => {\r\n                    res.json({ success: true, message });\r\n                }).catch(error => {\r\n                    throw error\r\n                });\r\n            }).catch(err => {\r\n                throw err\r\n            });\r\n        }).catch(err => {\r\n            throw err\r\n        });\r\n    }\r\n};\r\n\r\ngroupController.changeName = (req, res) => {\r\n  const {\r\n    groupId,\r\n    name\r\n  } = req.body;\r\n  const user = req.user;\r\n\r\n  if(user.permissions == 'teacher' || user.permissions == 'admin') {\r\n    db.Group.findByIdAndUpdate(groupId, { $set: { name } }).then(success => {\r\n      return res.json({ success: true });\r\n    });\r\n  }\r\n};\r\n\r\ngroupController.deleteMsg = (req, res) => {\r\n  const {\r\n    groupId,\r\n    msgId\r\n  } = req.body;\r\n  const user = req.user;\r\n\r\n  if(user.permissions == 'teacher' || user.permissions == 'admin') {\r\n    db.Group.findById(groupId).then(group => {\r\n      group.messages = group.messages.filter(item => item.id != msgId);\r\n      group.save().then(s => res.json({ success: true }));\r\n    });\r\n  }\r\n};\r\n\r\ngroupController.deleteGroup = (req, res) => {\r\n  const groupId = req.body.groupId;\r\n  const user = req.user;\r\n\r\n  if(user.permissions == 'teacher' || user.permissions == 'admin') {\r\n    db.Group.findByIdAndRemove(groupId).then(success => res.json({ success }));\r\n  }\r\n};\r\n\r\ngroupController.removeStudent = (req, res) => {\r\n  const {\r\n    groupId,\r\n    userId\r\n  } = req.body;\r\n  const user = req.user;\r\n\r\n  if(user.permissions == 'teacher' || user.permissions == 'admin') {\r\n    db.Group.findByIdAndUpdate(groupId, {\r\n      $pull: { '_students': userId }\r\n    }).then(success => { res.json({ success: true }) });\r\n  }\r\n};\r\n\r\nexport default groupController;\r\n"]}